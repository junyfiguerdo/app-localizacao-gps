<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador GPS - Figueredo Consultoria</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --color-bg-base: #0f172a;
            --color-bg-elevated: #1e293b;
            --color-bg-surface: #1e293b;
            --color-bg-muted: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-accent: #38bdf8;
            --color-accent-hover: #0ea5e9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--color-bg-base); color: var(--color-text-primary); font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; padding: 20px; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: var(--color-bg-elevated); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid var(--color-bg-muted); }
        .company-title { font-size: 14px; color: var(--color-accent); font-weight: 600; margin-bottom: 8px; letter-spacing: 0.5px; }
        h1 { font-size: 26px; color: #fff; margin-bottom: 20px; font-weight: 700; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 5px; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 12px; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; }
        select, input { background: var(--color-bg-base); border: 1px solid var(--color-bg-muted); border-radius: 8px; padding: 12px; color: #fff; font-size: 14px; transition: border-color 0.2s; }
        select:focus, input:focus { outline: none; border-color: var(--color-accent); }
        #map { height: 550px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--color-bg-muted); box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 1; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--color-bg-elevated); padding: 20px; border-radius: 12px; border: 1px solid var(--color-bg-muted); text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .stat-label { font-size: 13px; color: var(--color-text-muted); margin-bottom: 6px; font-weight: 500; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--color-accent); }
        .table-container { background: var(--color-bg-elevated); border-radius: 12px; overflow: auto; border: 1px solid var(--color-bg-muted); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 800px; }
        th { background: rgba(255,255,255,0.05); padding: 15px; text-align: left; color: var(--color-text-muted); font-weight: 600; border-bottom: 1px solid var(--color-bg-muted); }
        td { padding: 15px; border-top: 1px solid rgba(255,255,255,0.03); color: var(--color-text-secondary); }
        tr:hover td { background: rgba(56, 189, 248, 0.05); color: #fff; }
        .btn-apply { background: var(--color-accent); color: var(--color-bg-base); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; align-self: flex-end; }
        .btn-apply:hover { background: var(--color-accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); display: none; justify-content: center; align-items: center; z-index: 9999; font-weight: 600; color: var(--color-accent); font-size: 18px; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">‚åõ Carregando dados...</div>
    <div class="container">
        <div class="header">
            <div class="company-title">Figueredo Consultoria: Finan√ßas e Tecnologia</div>
            <h1>üåç Visualizador de Rotas GPS</h1>
            <div class="filters">
                <div class="filter-group">
                    <label>üë§ Usu√°rio</label>
                    <select id="filterUsuario"><option value="">Todos</option></select>
                </div>
                <div class="filter-group">
                    <label>üè¢ Empresa</label>
                    <select id="filterEmpresa"><option value="">Todos</option></select>
                </div>
                <div class="filter-group">
                    <label>üìÖ In√≠cio</label>
                    <input type="date" id="dateStart">
                </div>
                <div class="filter-group">
                    <label>üìÖ Fim</label>
                    <input type="date" id="dateEnd">
                </div>
                <button class="btn-apply" onclick="renderizar()">Aplicar Filtros</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">üõ£Ô∏è Dist√¢ncia Total</div><div id="distTotal" class="stat-value">0 km</div></div>
            <div class="stat-card"><div class="stat-label">üìç Pontos</div><div id="countPontos" class="stat-value">0</div></div>
            <div class="stat-card"><div class="stat-label">‚è±Ô∏è Tempo Total</div><div id="tempoTotal" class="stat-value">0h 0m</div></div>
        </div>

        <div id="map"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>üïí Data/Hora</th>
                        <th>üë§ Usu√°rio</th>
                        <th>üè¢ Empresa</th>
                        <th>üìç Local</th>
                                                        <th>üè∑Ô∏è Nome do Lugar</th>
                                                        <th>üè† Endere√ßo</th>
                                                        <th>üèôÔ∏è Cidade</th>
                                                        <th>üí∞ Valor</th>
                                                        <th>üìù Observa√ß√£o</th>
                                                <th>üåê Latitude</th>
                                                <th>üåê Longitude</th>
                        <th>üìè Dist√¢ncia</th>
                        <th>‚è≥ Perman√™ncia</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AkfycbyiMosFimLNbZhQtCVW_QjYM1iwjtTqc_JDPxFrGUxMcr8S5mqlmunU0vFQjHyPAnU3/usercontent';
        let allData = [];
         let markers = [];
 let map = null;
 let polyline = null;

        function initMap() {
            map = L.map('map').setView([-20.4222, -49.9722], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            polyline = L.polyline([], {color: '#38bdf8', weight: 4, opacity: 0.8}).addTo(map);
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(SCRIPT_URL + '?action=getData');
                const json = await res.json();
                allData = (json && json.data) || (json && Array.isArray(json) ? json : []);
                
            // Log para debug
            console.log('Dados recebidos:', json);
            console.log('Total de registros:', allData.length);
            
            if (!allData || allData.length === 0) {
                console.warn('‚ö†Ô∏è ATEN√á√ÉO: Nenhum dado foi retornado do servidor!');
                console.warn('Verifique se o Apps Script est√° funcionando corretamente.');
                console.warn('URL sendo consultada:', SCRIPT_URL + '?action=getData');
                alert('Nenhum dado encontrado! Verifique:\n1. Se voc√™ j√° capturou dados\n2. Se a URL do Apps Script est√° correta\n3. Se o Apps Script tem permiss√µes adequadas');
            }                updateSelects();
                renderizar();
            } catch (e) { console.error(e); }
            document.getElementById('loading').style.display = 'none';
        }

        function updateSelects() {
            const uSet = new Set(), eSet = new Set();
            allData.forEach(d => { if(d.usuario) uSet.add(d.usuario); if(d.empresa) eSet.add(d.empresa); });
            const uSel = document.getElementById('filterUsuario');
            const eSel = document.getElementById('filterEmpresa');
            const uVal = uSel.value, eVal = eSel.value;
            uSel.innerHTML = '<option value="">Todos</option>';
            eSel.innerHTML = '<option value="">Todos</option>';
            [...uSet].sort().forEach(u => uSel.innerHTML += `<option value="${u}">${u}</option>`);
            [...eSet].sort().forEach(e => eSel.innerHTML += `<option value="${e}">${e}</option>`);
            uSel.value = uVal; eSel.value = eVal;
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function renderizar() {
            const u = document.getElementById('filterUsuario').value;
            const e = document.getElementById('filterEmpresa').value;
            const s = document.getElementById('dateStart').value;
            const f = document.getElementById('dateEnd').value;

            const filtered = allData.filter(d => {
                const date = d.dataHora.split('T')[0];
                return (!u || d.usuario === u) &&
                       (!e || d.empresa === e) &&
                       (!s || date >= s) &&
                       (!f || date <= f);
            });

            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            let totalDist = 0, totalMs = 0, latlngs = [];
            
            filtered.forEach((d, i) => {
                const pos = [d.latitude, d.longitude];
                latlngs.push(pos);
                const marker = L.circleMarker(pos, {radius: 7, color: i === 0 ? '#10b981' : (i === filtered.length-1 ? '#ef4444' : '#38bdf8')}).addTo(map);
                marker.bindPopup(`<b>${d.nome || 'Ponto'}</b><br>üïí ${new Date(d.dataHora).toLocaleString()}<br>üë§ ${d.usuario || '--'}`);
                markers.push(marker);

                let distStr = '--', stayStr = '--';
                if(i > 0) {
                    const dPrev = filtered[i-1];
                    const dist = calcularDistancia(dPrev.latitude, dPrev.longitude, d.latitude, d.longitude);
                    totalDist += dist; distStr = dist.toFixed(2) + ' km';
                    const ms = new Date(d.dataHora) - new Date(dPrev.dataHora);
                    totalMs += ms;
                    const mins = Math.floor(ms / 60000);
                    stayStr = mins > 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
                }

                tbody.innerHTML += `<tr>
                    <td>${new Date(d.dataHora).toLocaleString()}</td>
                    <td>${d.usuario || '--'}</td>
                    <td>${d.empresa || '--'}</td>
                    <td>${d.local || '--'} ${d.nome ? '- '+d.nome : ''}</td>
                                    <td>${d.nome || '--'}</td>
                                                    <td>${d.endereco || '--'}</td>
                                                                    <td>${d.cidade || '--'}</td>
                                                                                    <td>${d.valor || '--'}</td>
                                                                                                    <td>${d.observacao || '--'}</td>
                <td>${d.latitude.toFixed(6)}</td> <td>${d.longitude.toFixed(6)}</td> <td>${distStr}</td>
                <td>${stayStr}</td>
                </tr>`;
            });

            if(latlngs.length > 0) {
                polyline.setLatLngs(latlngs);
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            }
            document.getElementById('distTotal').textContent = totalDist.toFixed(2) + ' km';
            document.getElementById('countPontos').textContent = filtered.length;
            const h = Math.floor(totalMs/3600000);
            const m = Math.floor((totalMs%3600000)/60000);
            document.getElementById('tempoTotal').textContent = `${h}h ${m}m`;
        }

        initMap();
        loadData();
         setInterval(loadData, 60000);
        
    </script>
</body>
</html>
